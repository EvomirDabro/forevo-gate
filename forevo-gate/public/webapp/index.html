<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FOREVO Gate</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #0b1020; color: #e9eefc; }
      .card { max-width: 560px; margin: auto; padding: 24px; border: 1px solid #24304d; border-radius: 16px; background: #121a33; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
      h2 { margin-top: 0; }
      .muted { color: #9fb0d6; }
      .ok { color: #44d17a; }
      .err { color: #ff6b6b; }
      a.btn, button { display: inline-block; padding: 12px 16px; border-radius: 10px; border: 1px solid #2a3c66; text-decoration: none; color: #e9eefc; background: #1a2444; cursor: pointer; }
      #tc { margin: 16px 0 8px; }
    </style>
    <!-- TonConnect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="card">
      <h2>FOREVO — доступ по NFT</h2>
      <p class="muted">Подключите TON‑кошелёк. Я проверю наличие FOREVO NFT и отправлю кнопку для вступления в закрытый чат.</p>

      <div id="tc"></div>
      <p id="status" class="muted"></p>
      <p id="result"></p>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      tg?.expand();

      // --- 1) читаем tg_id из query (?tg_id=) и из Telegram SDK, сохраняем в localStorage ---
      const params = new URLSearchParams(window.location.search);
      const tgIdFromQuery = params.get('tg_id');
      if (tgIdFromQuery) localStorage.setItem('tg_id', String(tgIdFromQuery));

      const tgIdFromTelegram = tg?.initDataUnsafe?.user?.id;
      if (tgIdFromTelegram) localStorage.setItem('tg_id', String(tgIdFromTelegram));

      const getTgId = () => tg?.initDataUnsafe?.user?.id || tgIdFromQuery || localStorage.getItem('tg_id');

      // --- 2) TonConnect UI ---
      const tcui = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://forevo-gate.onrender.com/webapp/tonconnect-manifest.json',
        buttonRootId: 'tc',
        actionsConfiguration: {
          // постараемся вернуть в Telegram после подключения
          twaReturnUrl: window.location.href
        }
      });

      async function waitConnected() {
        const restored = await tcui.connectionRestored;
        if (restored) return tcui.account?.address;
        await tcui.openModal();
        return new Promise((resolve) => {
          const unsub = tcui.onStatusChange((w) => {
            if (w) { unsub(); resolve(tcui.account?.address); }
          });
        });
      }

      ;(async () => {
        document.getElementById('status').innerText = 'Ожидаю подключение кошелька…';
        const wallet = await waitConnected();
        document.getElementById('status').innerText = 'Кошелёк подключён: ' + wallet;

        const tg_id = getTgId();
        if (!tg_id) {
          document.getElementById('result').innerHTML =
            '<span class="err">Не вижу ваш Telegram ID. Откройте эту страницу через кнопку бота.</span>';
          return;
        }

        // Явный URL до API на Render
        const VERIFY_URL = 'https://forevo-gate.onrender.com/api/verify';

        const r = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tg_id, wallet })
        }).catch(() => null);

        if (!r || !r.ok) {
          document.getElementById('result').innerHTML =
            '<span class="err">Не удалось связаться с сервером проверки. Попробуйте позже.</span>';
          return;
        }

        const data = await r.json();
        if (data.ok) {
          document.getElementById('result').innerHTML =
            '<span class="ok">NFT найден ✅. Вернитесь в бот — он пришлёт кнопку для вступления.</span>';
          tg?.close();
        } else {
          document.getElementById('result').innerHTML =
            '<span class="err">NFT не найден. Нужен FOREVO NFT на кошельке.</span>';
        }
      })();
    </script>
  </body>
</html>
